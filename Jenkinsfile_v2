/* groovylint-disable-next-line CompileStatic */
@NonCPS
def generateTag() {
    return "build-" + new Date().format("yyyyMMdd-HHmmss")
}

pipeline{
    environment
    {
        registry = "swathiguptha/student-form-image"
        registryCredential = "docker-login"
    }
    agent any
    stages
    {
        stage('Install Maven') {
            steps {
                script {
                    def mvnHome = tool name: 'Maven', type: 'hudson.tasks.Maven$MavenInstallation'
                    sh "wget https://mirrors.estointernet.in/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz"
                    sh "tar -xvf apache-maven-3.6.3-bin.tar.gz"
                    sh "mv apache-maven-3.6.3 $mvnHome"
                }
            }
        }
        stage('Maven Build')
        {
            steps
            {
                script
                {
                    sh 'mvn clean package'
                }
            }
        }
        stage('Building docker image')
        {
            steps
            {
                script
                {
                    
                    sh 'echo ${BUILD_TIMESTAMP}'
                    tag = generateTag()
                    image = docker.build("swathiguptha/student-form-image:"+tag)
                }
            }
        }
        stage('deploy docker image')
        {
            steps
            {
                script
                {
                    docker.withRegistry('',registryCredential)
                    {
                        image.push()
                    }
                }
            }
        }
        stage('Deploying Rancher to single nodes') 
        {
            steps
            {
                script
                {

                    sh 'pwd'
                    sh 'kubectl --kubeconfig=/home/ubuntu/.kube/config.yaml set image deployment/form-deployment container-0=swathiguptha/student-form-image:'+tag
                }
            }
        }

    }
}